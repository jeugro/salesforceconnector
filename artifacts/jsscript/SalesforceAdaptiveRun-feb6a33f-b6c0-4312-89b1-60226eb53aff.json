{
	"id": "feb6a33f-b6c0-4312-89b1-60226eb53aff",
	"createdAt": "2022-06-04T06:10:36.000Z",
	"createdBy": "ole-andre.haugen@neptune-software.com",
	"globalScripts": [],
	"externalModules": [],
	"entitySets": [
		{
			"id": "0a8bfac1-07cd-4bfc-bddb-85562ea67e3a",
			"name": "p9_sf_connector",
			"contextname": "p9_sf_connector"
		}
	],
	"apis": [
		{
			"id": "7641f0ef-4fec-48a2-9084-651b32a540ea",
			"parent": "28abbaa4-5fbb-4e19-815f-0a6aa6bed859",
			"name": "/services/data/v53.0/query",
			"contextname": "query",
			"method": "GET"
		}
	],
	"name": "SalesforceAdaptiveRun",
	"ver": "22.10.30.947",
	"description": "Run Report",
	"content": [
		"==OBJECT STRING==",
		"try {\r",
		"\r",
		"    // result.data = req.body;\r",
		"    // return complete();\r",
		"\r",
		"    const connector = await entities.p9_sf_connector.findOne({\r",
		"        select: [\"table\", \"metadata\"],\r",
		"        where: {\r",
		"            id: req.body._connector.settings.startParam\r",
		"        }\r",
		"    });\r",
		"\r",
		"    if (!connector) return complete();\r",
		"\r",
		"    let runMode = ((req.body._keyField) ? \"Form\" : \"List\");\r",
		"    let counter;\r",
		"    let pagination = \"\";\r",
		"    let order = \"\";\r",
		"    let where = \"\";\r",
		"    let whereSep = \"\";\r",
		"    let fields = \"\";\r",
		"    let sep = \"\";\r",
		"\r",
		"    //  Fields Selection \r",
		"    if (runMode == \"Form\") {\r",
		"\r",
		"        req.body._settings.fieldsSel.forEach(function (field) {\r",
		"\r",
		"            const fieldMeta = connector.metadata.fields.find((f) => f.name === field.name);\r",
		"\r",
		"            if (fieldMeta) {\r",
		"                fields += sep + field.name;\r",
		"                sep = \",\";\r",
		"                if (fieldMeta.relationshipName && fieldMeta.lookupField) fields += sep + fieldMeta.relationshipName + \".\" + fieldMeta.lookupField;\r",
		"            }\r",
		"\r",
		"        });\r",
		"\r",
		"        // Where \r",
		"        req.body._keyField.forEach(function (keyField) {\r",
		"            where += whereSep + keyField.fieldName + \" = '\" + req.body[keyField.fieldName] + \"'\";\r",
		"            whereSep = \" AND \";\r",
		"        });\r",
		"\r",
		"    } else {\r",
		"\r",
		"        req.body._settings.fieldsRun.forEach(function (field) {\r",
		"\r",
		"            const fieldMeta = connector.metadata.fields.find((f) => f.name === field.name);\r",
		"\r",
		"            if (fieldMeta) {\r",
		"                fields += sep + field.name;\r",
		"                sep = \",\";\r",
		"                if (fieldMeta.relationshipName && fieldMeta.lookupField) fields += sep + fieldMeta.relationshipName + \".\" + fieldMeta.lookupField;\r",
		"            }\r",
		"\r",
		"        });\r",
		"\r",
		"        // Where \r",
		"        const bodyFields = Object.keys(req.body);\r",
		"\r",
		"        bodyFields.forEach(function (fieldName) {\r",
		"\r",
		"            if (fieldName.substr(0, 1) !== \"_\") {\r",
		"\r",
		"                const fieldValue = req.body[fieldName];\r",
		"                if (!fieldValue) return;\r",
		"\r",
		"                const fieldSel = req.body._settings.fieldsSel.find((f) => f.name === fieldName);\r",
		"                if (!fieldSel) return;\r",
		"\r",
		"                const fieldMeta = connector.metadata.fields.find((f) => f.name === fieldName);\r",
		"                if (!fieldMeta) return;\r",
		"\r",
		"                switch (fieldSel.type) {\r",
		"\r",
		"                    case \"CheckBox\":\r",
		"                    case \"Switch\":\r",
		"                        where += whereSep + \" \" + fieldName + \" = \" + fieldValue;\r",
		"                        break;\r",
		"\r",
		"                    case \"DateRange\":\r",
		"                        where += whereSep + \" \" + fieldName + \" >= \" + fieldValue;\r",
		"                        where += whereSep + \" \" + fieldName + \" <= \" + req.body[fieldName + \"_end\"];\r",
		"                        break;\r",
		"\r",
		"                    case \"SingleSelect\":\r",
		"                    case \"SingleSelectLookup\":\r",
		"                    case \"SingleSelectScript\":\r",
		"                        if (fieldMeta.type === \"datetime\") {\r",
		"                            where += whereSep + \" \" + fieldName + \" = \" + fieldValue;\r",
		"                        } else {\r",
		"                            where += whereSep + \" \" + fieldName + \" = '\" + fieldValue + \"'\";\r",
		"                        }\r",
		"                        break;\r",
		"\r",
		"                    case \"MultiSelect\":\r",
		"                    case \"MultiSelectLookup\":\r",
		"                    case \"MultiSelectScript\":\r",
		"                        let includes = \"\";\r",
		"                        let sep = \"\";\r",
		"\r",
		"                        fieldValue.forEach(function (value, index, array) {\r",
		"                            includes += sep + \"'\" + value + \"'\";\r",
		"                            sep = \",\";\r",
		"                        });\r",
		"\r",
		"                        where += whereSep + \" \" + fieldName + \" IN (\" + includes + \")\";\r",
		"                        break;\r",
		"\r",
		"                    default:\r",
		"                        if (fieldMeta.type === \"id\" || fieldMeta.type === \"reference\") {\r",
		"                            where += whereSep + \" \" + fieldName + \" = '\" + fieldValue + \"'\";\r",
		"                        } else if (fieldMeta.type === \"boolean\") {\r",
		"                            where += whereSep + \" \" + fieldName + \" = \" + fieldValue;\r",
		"                        } else {\r",
		"                            where += whereSep + \" \" + fieldName + \" LIKE '%\" + fieldValue + \"%'\";\r",
		"                        }\r",
		"                        break;\r",
		"\r",
		"                }\r",
		"\r",
		"                whereSep = \" AND \";\r",
		"\r",
		"            }\r",
		"\r",
		"        });\r",
		"\r",
		"    }\r",
		"\r",
		"    // Order\r",
		"    if (req.body._order) {\r",
		"\r",
		"        const orderField = Object.keys(req.body._order)[0];\r",
		"\r",
		"        if (orderField) {\r",
		"            const orderType = req.body._order[orderField];\r",
		"            order += \" ORDER BY \" + orderField + \" \" + orderType;\r",
		"        }\r",
		"\r",
		"    }\r",
		"\r",
		"    // Pagination\r",
		"    if (req.body._pagination) {\r",
		"\r",
		"        let queryCount = \"SELECT count() FROM \" + connector.table;\r",
		"        if (where) queryCount += \" WHERE \" + where;\r",
		"\r",
		"        const responseCount = await apis.query({ parameters: { \"q\": queryCount } });\r",
		"        if (responseCount && responseCount.data && responseCount.data.totalSize) counter = responseCount.data.totalSize;\r",
		"\r",
		"        pagination += \" LIMIT \" + req.body._pagination.take;\r",
		"        pagination += \" OFFSET \" + req.body._pagination.skip;\r",
		"\r",
		"    }\r",
		"\r",
		"    // Start Query API\r",
		"    let queryData = \"SELECT \" + fields + \" FROM \" + connector.table;\r",
		"    if (where) queryData += \" WHERE \" + where;\r",
		"    if (order) queryData += order;\r",
		"    if (pagination) queryData += pagination;\r",
		"\r",
		"    const responseRecords = await apis.query({ parameters: { \"q\": queryData } });\r",
		"\r",
		"    // Merge LookupFields from SalesForce\r",
		"    responseRecords.data.records.forEach(function (row) {\r",
		"\r",
		"        let rowFields = Object.keys(row);\r",
		"\r",
		"        // Populate Data\r",
		"        rowFields.forEach(function (fieldName) {\r",
		"            const fieldMeta = connector.metadata.fields.find((f) => f.name === fieldName);\r",
		"            if (fieldMeta && fieldMeta.relationshipName && fieldMeta.lookupField) row[fieldName] = row[fieldMeta.relationshipName][fieldMeta.lookupField];\r",
		"        });\r",
		"\r",
		"        // Cleanup Data\r",
		"        rowFields.forEach(function (fieldName) {\r",
		"            const fieldMeta = connector.metadata.fields.find((f) => f.name === fieldName);\r",
		"            if (fieldMeta && fieldMeta.relationshipName && fieldMeta.lookupField) delete row[fieldMeta.relationshipName];\r",
		"            delete row[\"attributes\"];\r",
		"        });\r",
		"\r",
		"        rowFields = Object.keys(row);\r",
		"\r",
		"        // Adaptive Framework Binding \r",
		"        rowFields.forEach(function (fieldName) {\r",
		"            // const fieldMeta = connector.metadata.fields.find((f) => f.name === fieldName);\r",
		"            const fieldRun = req.body._settings.fieldsRun.find((f) => f.name === fieldName);\r",
		"\r",
		"            if (fieldRun) {\r",
		"\r",
		"                switch (fieldRun.type) {\r",
		"\r",
		"                    case \"ObjectStatus\":\r",
		"\r",
		"                        // Unit\r",
		"                        if (fieldRun.statusUnitType === \"Binding\") row[fieldName + \"_unit\"] = row[fieldRun.statusUnitBinding];\r",
		"                        if (fieldRun.statusUnitType === \"Fixed\") row[fieldName + \"_unit\"] = fieldRun.statusUnitFixed;\r",
		"\r",
		"                        // State\r",
		"                        if (fieldRun.statusStateType === \"Binding\") row[fieldName + \"_state\"] = row[fieldRun.statusStateBinding];\r",
		"                        if (fieldRun.statusStateType === \"Fixed\") row[fieldName + \"_state\"] = fieldRun.statusStateFixed;\r",
		"\r",
		"                        // Icon\r",
		"                        if (fieldRun.statusIconType === \"Binding\") row[fieldName + \"_icon\"] = row[fieldRun.statusIconBinding];\r",
		"                        if (fieldRun.statusIconType === \"Fixed\") row[fieldName + \"_icon\"] = fieldRun.statusIconFixed;\r",
		"\r",
		"                        // Title\r",
		"                        if (fieldRun.statusTitleType === \"Binding\") row[fieldName + \"_title\"] = row[fieldRun.statusTitleBinding];\r",
		"                        if (fieldRun.statusTitleType === \"Fixed\") row[fieldName + \"_title\"] = fieldRun.statusTitleFixed;\r",
		"\r",
		"                        break;\r",
		"\r",
		"                    case \"ObjectNumber\":\r",
		"\r",
		"                        // Unit\r",
		"                        if (fieldRun.numberUnitType === \"Binding\") row[fieldName + \"_unit\"] = row[fieldRun.numberUnitBinding];\r",
		"                        if (fieldRun.numberUnitType === \"Fixed\") row[fieldName + \"_unit\"] = fieldRun.numberUnitFixed;\r",
		"\r",
		"                        // State\r",
		"                        if (fieldRun.numberStateType === \"Binding\") row[fieldName + \"_state\"] = row[fieldRun.numberStateBinding];\r",
		"                        if (fieldRun.numberStateType === \"Fixed\") row[fieldName + \"_state\"] = fieldRun.numberStateFixed;\r",
		"\r",
		"                        break;\r",
		"\r",
		"                    default:\r",
		"                        break;\r",
		"                }\r",
		"            }\r",
		"        });\r",
		"\r",
		"\r",
		"    });\r",
		"\r",
		"    if (runMode == \"Form\") {\r",
		"\r",
		"        result.data = responseRecords.data.records;\r",
		"\r",
		"    } else {\r",
		"\r",
		"        if (!req.body._pagination) counter = responseRecords.data.records.length;\r",
		"\r",
		"        result.data = {\r",
		"            result: responseRecords.data.records,\r",
		"            count: counter\r",
		"        }\r",
		"\r",
		"    }\r",
		"\r",
		"\r",
		"    complete();\r",
		"\r",
		"} catch (e) {\r",
		"\r",
		"    result.data = {\r",
		"        status: \"ERROR\",\r",
		"        message: e\r",
		"    }\r",
		"\r",
		"    complete();\r",
		"\r",
		"}\r",
		"\r",
		"\r",
		""
	],
	"useAsGlobalScript": false,
	"isTypescript": false,
	"transpiledContent": null,
	"lastRunSuccessful": true,
	"jsscriptGroup": "8724ce1d-db36-43cb-a923-3e0be5432b2a",
	"package": "ace216dd-a722-4e40-9d39-6049629fca12"
}